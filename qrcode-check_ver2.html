<script>
    const video = document.getElementById('qr-video');
    const canvas = document.getElementById('qr-canvas');
    const canvasContext = canvas.getContext('2d');
    const scanStatusSpan = document.getElementById('scan-status');
    const code1ResultSpan = document.getElementById('code1-result');
    const code2ResultSpan = document.getElementById('code2-result');
    const scan1Button = document.getElementById('scan1-button');
    const scan2Button = document.getElementById('scan2-button');
    const resetButton = document.getElementById('reset-button');
    const cameraErrorDiv = document.getElementById('camera-error');
    const comparisonBlockResultDiv = document.getElementById('comparison-block-result');
    const comparisonSecondaryMessageP = document.getElementById('comparison-secondary-message');
    const currentTimeDisplay = document.getElementById('current-time-display');
    
    const performerNameInput = document.getElementById('performer-name');
    const verifierNameInput = document.getElementById('verifier-name');
    const sendDataButton = document.getElementById('send-data-button');
    const sendStatusMessage = document.getElementById('send-status-message');

    let code1 = null;
    let code2 = null;
    let currentScanTarget = 0;
    let animationFrameId = null;

    function updateCurrentTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        
        currentTimeDisplay.textContent = `現在時刻: ${year}年${month}月${day}日 ${hours}時${minutes}分`;
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            video.setAttribute('playsinline', true);
            video.play();
            
            scanStatusSpan.textContent = '準備ができました。「QRコード（１）スキャンする」を押してください。';
            cameraErrorDiv.style.display = 'none';
            
            animationFrameId = requestAnimationFrame(tick);
        } catch (err) {
            console.error('カメラアクセスエラー:', err);
            cameraErrorDiv.style.display = 'block';
            scanStatusSpan.textContent = 'カメラ起動失敗';
            disableButtons();
        }
    }

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }
            
            canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            if (currentScanTarget > 0) {
                const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    drawBoundingBox(code.location);
                    
                    const currentCode = code.data;
                    if (currentScanTarget === 1 && code1 === null) {
                        code1 = currentCode;
                        code1ResultSpan.innerHTML = `<span class="scanned-code">${escapeHTML(code1)}</span>`;
                        scanStatusSpan.textContent = '最初のQRコードを読み取りました。「QRコード（２）スキャンする」を押してください。';
                        currentScanTarget = 0;
                        scan1Button.disabled = true;
                        scan2Button.disabled = false;
                    } else if (currentScanTarget === 2 && code2 === null && currentCode !== code1) {
                        code2 = currentCode;
                        code2ResultSpan.innerHTML = `<span class="scanned-code">${escapeHTML(code2)}</span>`;
                        scanStatusSpan.textContent = '2番目のQRコードを読み取りました。';
                        currentScanTarget = 0;
                        scan2Button.disabled = true;
                        compareCodes();
                    } else if (currentScanTarget === 2 && currentCode === code1) {
                        // console.log("Code2スキャン中にCode1と同じコードを検出。異なるコードを待機。");
                    }
                }
            }
        }
        animationFrameId = requestAnimationFrame(tick);
    }

    function drawBoundingBox(location) {
        canvasContext.strokeStyle = "#FF0000";
        canvasContext.lineWidth = 4;
        canvasContext.beginPath();
        canvasContext.moveTo(location.topLeftCorner.x, location.topLeftCorner.y);
        canvasContext.lineTo(location.topRightCorner.x, location.topRightCorner.y);
        canvasContext.lineTo(location.bottomRightCorner.x, location.bottomRightCorner.y);
        canvasContext.lineTo(location.bottomLeftCorner.x, location.bottomLeftCorner.y);
        canvasContext.lineTo(location.topLeftCorner.x, location.topLeftCorner.y);
        canvasContext.stroke();
    }

    function compareCodes() {
        if (code1 !== null && code2 !== null) {
            const firstTwoCode1 = code1.substring(0, 2);
            const firstTwoCode2 = code2.substring(0, 2);
            
            let isMatch = false;
            
            if (firstTwoCode1 === firstTwoCode2) {
                isMatch = false;
            } else {
                const restCode1 = code1.substring(2);
                const restCode2 = code2.substring(2);

                if (restCode1 === restCode2) {
                    isMatch = true;
                } else {
                    isMatch = false;
                }
            }

            if (isMatch) {
                comparisonBlockResultDiv.textContent = 'OK';
                comparisonBlockResultDiv.className = 'match';
                comparisonSecondaryMessageP.textContent = 'ETC番号が一致しました';
                comparisonSecondaryMessageP.className = 'match';
            } else {
                comparisonBlockResultDiv.textContent = 'NG';
                comparisonBlockResultDiv.className = 'mismatch';
                comparisonSecondaryMessageP.textContent = 'ETC番号が一致しませんでした';
                comparisonSecondaryMessageP.className = 'mismatch';
            }
                
            checkIfReadyToSend();
        } else {
            comparisonBlockResultDiv.textContent = '---';
            comparisonBlockResultDiv.className = '';
            comparisonSecondaryMessageP.textContent = '---';
            comparisonSecondaryMessageP.className = '';
            checkIfReadyToSend();
        }
    }
    
    function disableButtons() {
        scan1Button.disabled = true;
        scan2Button.disabled = true;
        resetButton.disabled = true;
        sendDataButton.disabled = true;
    }

    scan1Button.addEventListener('click', () => {
        if (code1 === null && currentScanTarget === 0) {
            currentScanTarget = 1;
            scanStatusSpan.textContent = '最初のQRコードをスキャン中...';
            scan1Button.disabled = true;
            comparisonBlockResultDiv.textContent = '---';
            comparisonBlockResultDiv.className = '';
            comparisonSecondaryMessageP.textContent = '---';
            comparisonSecondaryMessageP.className = '';
            checkIfReadyToSend();
        }
    });

    scan2Button.addEventListener('click', () => {
        if (code1 !== null && code2 === null && currentScanTarget === 0) {
            currentScanTarget = 2;
            scanStatusSpan.textContent = '2番目のQRコードをスキャン中... (最初のコードと異なるコードをかざしてください)';
            scan2Button.disabled = true;
            comparisonBlockResultDiv.textContent = '---';
            comparisonBlockResultDiv.className = '';
            comparisonSecondaryMessageP.textContent = '---';
            comparisonSecondaryMessageP.className = '';
            checkIfReadyToSend();
        }
    });

    resetButton.addEventListener('click', () => {
        currentScanTarget = 0;
        code1 = null;
        code2 = null;
        code1ResultSpan.textContent = '---';
        code2ResultSpan.textContent = '---';
        scanStatusSpan.textContent = '準備ができました。「QRコード（１）をスキャン」を押してください。';
        scan1Button.disabled = false;
        scan2Button.disabled = true;
        comparisonBlockResultDiv.textContent = '---';
        comparisonBlockResultDiv.className = '';
        comparisonSecondaryMessageP.textContent = '---';
        comparisonSecondaryMessageP.className = '';
        canvasContext.clearRect(0, 0, canvas.width, canvas.height);
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
        }
        checkIfReadyToSend();
    });

    function escapeHTML(str) {
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;')
                  .replace(/'/g, '&#39;');
    }
    
    /**
     * データを送信できる状態かチェックし、送信ボタンを有効/無効化する
     */
    function checkIfReadyToSend() {
        const isScannedAndCompared = code1 !== null && code2 !== null && comparisonBlockResultDiv.textContent !== '---';
        const isPerformerNameEntered = performerNameInput.value.trim() !== '';
        const isVerifierNameEntered = verifierNameInput.value.trim() !== '';

        sendDataButton.disabled = !(isScannedAndCompared && isPerformerNameEntered && isVerifierNameEntered);
    }

    /**
     * 外部API（GAS）にデータをPOST送信する関数
     */
    async function sendDataToApi() {
        const endpointUrl = 'https://script.google.com/macros/s/AKfycbwV00jAGgvWg_vFQeiEZwpqYcgH1kSN2mEnZ6KT8dUiUQnEfpJYL0IPYPtccsBIEiOz0g/exec';

        const dataToSend = {
            timestamp: new Date().toISOString(),
            performer: performerNameInput.value.trim(),
            verifier: verifierNameInput.value.trim(),
            result: comparisonBlockResultDiv.textContent,
            code1: code1,
            code2: code2
        };

        sendDataButton.disabled = true;
        performerNameInput.disabled = true;
        verifierNameInput.disabled = true;
        sendStatusMessage.textContent = '送信中...';
        sendStatusMessage.style.color = '#333';

        try {
            const response = await fetch(endpointUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend),
                mode: 'no-cors'
            });
            
            sendStatusMessage.textContent = 'データが正常に送信されました！ ✅';
            sendStatusMessage.style.color = 'green';
            
        } catch (error) {
            console.error('送信エラー:', error);
            sendStatusMessage.textContent = 'データの送信に失敗しました。再試行してください。';
            sendStatusMessage.style.color = 'red';
            
        } finally {
            sendDataButton.disabled = false;
            performerNameInput.disabled = false;
            verifierNameInput.disabled = false;
        }
    }

    sendDataButton.addEventListener('click', sendDataToApi);
    performerNameInput.addEventListener('input', checkIfReadyToSend);
    verifierNameInput.addEventListener('input', checkIfReadyToSend);
    
    startCamera();
    updateCurrentTime();
    setInterval(updateCurrentTime, 60 * 1000);
</script>